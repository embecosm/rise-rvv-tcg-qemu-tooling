# Memcpy benchmarks

These programs and scripts allow measurement of QEMU performance with
different `memcpy` implementations.  The programs can be run with a variety of
LMUL and VLEN values and various data block sizes.  We provide three `memcpy`
implementations.

- "Scalar" `memcpy`, taken from Newlib
- "Vector" `memcpy`, taken from the RISC-V Vector standard
- "Bionic" `memcpy`, almost identical to the "Vector" `memcpy`.

# Building the code

Build the code wiht `make`. Ensure you have a suitable RISC-V GCC on your
path.
```
make
```

## Benchmarking

The general principle is to run each benchmark with a large number of
iterations of `memcpy` and then with a small number or iterations.
Subtracting the two times leaves the time due to just `memcpy`, with all the
checking overhead removed.

The `run-memcpy.sh` script will run a single benchmark.  Use the `--help`
option to see arguments and the comments in the script.

The `run-sequence.sh` script will run a large number of benchmarks for
different values of VLEN and LMUL and for a range of data sizes.  Again use
the `--help` option to see arguments and look at the comments in the script.

## Scripts to help with Linux _perf_

### Prerequisites

The scripts are intended to run under Linux.  Prequisites are Linux _perf_ and
_csvtool_, both of which should be available with standard distributions.

### `run_perf.sh`

```
./run-perf.sh [--bytes <num>] [--resdir <dir>] [--sizes <list>]
```

Uses Linux _perf_ to profile different variants of the `memcpy` benchmark.
Arguments are as follows.

- `--bytes` _num_ : Total bytes to copy (optional).  Default 1,000,000,000.

- `--resdir` _dir_ : Directory in which to place the results (optional).
  Default is `res-baseline` in the directory holding this script.

- `--sizes` _list_ : Space separated list of the data sizes to use when
  creating results (optional).  Default list is all the powers of 2, 3, 5 and
  7 up to 5<sup>6</sup>.

The results will be three sets of files of the form
`prof-`_type_`-`_size_`.res`, where `type` is one of `scalar`, `vector-small`
or `vector-large`, and _size_, is the size of the data block copied on each
iteration.

The total number of iterations for each test is determined by the number given
in the `--bytes` argument divided by the size of the data block being used for
the run.

`perf record` is run using DWARF to determine the call graph.  This gives
accurate results, but is slow.  Expect each iteration to take of the order of
20 minutes on a decent server.

### `extract-top-level-funcs.sh`

```
./extract-top-level-funcs.sh --resfile <file> [--cutoff <num>] \
    [--total|--self] [--omit-empty] [--md | --csv]
```

Extract the main results from a file generated by `run_perf.sh`.  Arguments
are as follows.

- `--resfile` _file_: Target file to extract results from (mandatory)
- `--cutoff` _num_: Percentage below which to stop showing results
  (optional). Default value 1
- `--total`: Cutoff and sorting based on total time (self + children)
  (optional). Set by default.
- `--self`: Cutoff and sorting just based on self time (no children)
  (optional). Opposite to `--total`, so not set by default.
- `--omit-empty`: Do not show results if self is 0.00 (optional).  Only has
  any effect in combination with `--total`.
- `--md`: Output results in MarkDown format (optional). Set by default
- `--csv`: Output results in CSV format.

**Note.** Only one of `--total` or `--self` may be specified.  Only one of
`--md` or `--csv` may be specified.

This is the central file for extracting data from the Linux _perf_ results.
In general using `--self` gives the most useful data for targeting
optimizations. Using `--total` will flag up these functions, but also
functions which are just wrappers for other functions.  The `--omit-empty`
option can be helpful when using `--total` to skip functions which are purely
wrapping other functions.

### `count-top-funcs.sh`

```
Usage ./count-top-funcs.sh [--resdir <dir>] [--total|--self] [--md | --csv]
```

Find the frequency of the most used functions in a set of data.  This is a
wrapper for `extract-top-level-funcs`.  Arguments are as follows.

- `--resdir` _dir_: Directory with the results to be analysed (optional).
  Default `res-baseline`
- `--total`: Cutoff and sorting based on total time (self + children)
  (optional). Set by default.
- `--self`: Cutoff and sorting just based on self time (no children)
  (optional). Opposite to `--total`, so not set by default.
- `--md`: Output results in MarkDown format (optional). Set by default
- `--csv`: Output results in CSV format.

**Note.** Only one of `--total` or `--self` may be specified.  Only one of
`--md` or `--csv` may be specified.

The results to be analysed will be in files of the form
`prof-`_type_`-`_size_`.res`, where _type_ is one of `scalar`, `vector-small`
or `vector-large`, and _size_, is the size of the data block in bytes copied
on each iteration.

### `profile-all-funcs.sh`

```
./profile-all-funcs.sh [--resdir <dir>] [--type <str>] [--total|--self] \
    [--funclist <list>]
```

Extract data on function usage for different data sizes in a form suitable for
graphical analysis.  Arguments are as follows.

- `--resdir` _dir_: Directory with the results to be analysed (optional).
  Default `res-baseline`.
- `--type` _str_: What type of result to look at (optional).  Permitted values
  are `scalar` (default), `vector-small` or `vector-large`.
- `--total`: Cutoff and sorting based on total time (self + children)
  (optional). Set by default.
- `--self`: Cutoff and sorting just based on self time (no children)
  (optional). Opposite to `--total`, so not set by default.
- `--funclist` _list_: Space separated list of functions to profile. Default
  value `helper_lookup_tb_ptr cpu_get_tb_cpu_state`

**Note.** Only one of `--total` or `--self` may be specified.

This script typically takes a set of functions identified by
`count-top-funcs.sh`.  The output is always CSV format.

### `run-spec-pop2.sh`

```
./run-spec-pop2.sh [--reportfile <file>] [--specdir <dir>]
```

**Note.** Because this is not specific to the `memcpy` benchmarks it lives in
the main `tooling` repository.  Arguments are as follows.

- `--reportfile` _file_: Put the results in this file. Default
  `prof-628.pop2_s.res` in the `tooling` repository

- `--specdir` _dir_: The directory holding the SPEC installation to be used.

This script runs the SPEC CPU 2017 benchmark under QEMU with Linux _perf_.
The script runs a previously built benchmark.  If necessary use
`runspec-qemu.sh` to create the benchmark binary.
